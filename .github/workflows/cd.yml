name: CI/CD - Windows Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Example: v1.0.0
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up MSVC (Visual Studio Dev Command Prompt)
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build executables
      shell: cmd
      run: |
        set SQLITE_FLAGS=/DSQLITE_OMIT_LOAD_EXTENSION /DSQLITE_ENABLE_RTREE /DSQLITE_ENABLE_FTS3
        set COMMON_FLAGS=/EHsc /std:c++17
        set WARNING_FLAGS=/W3 /wd4996 /wd4244 /wd4267 /wd4018

        echo Building main_basic.exe...
        cl %COMMON_FLAGS% %WARNING_FLAGS% %SQLITE_FLAGS% /Fe:main_basic.exe main.cpp sqlite3.c

        echo Building main_debug.exe...
        cl %COMMON_FLAGS% %WARNING_FLAGS% %SQLITE_FLAGS% /Zi /DDEBUG /Fe:main_debug.exe main.cpp sqlite3.c

        echo Building main_optimized.exe...
        cl %COMMON_FLAGS% %WARNING_FLAGS% %SQLITE_FLAGS% /O2 /DNDEBUG /Fe:main_optimized.exe main.cpp sqlite3.c

    - name: Upload Release Artifacts
      uses: softprops/action-gh-release@v1
      with:
        files: |
          main_basic.exe
          main_debug.exe
          main_optimized.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
